// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  //refreshToken        String?
  //refreshTokenExpires DateTime?
}

model IngramCredential {
  shopDomain            String   @id
  clientId              String
  clientSecret          String
  customerNumber        String
  countryCode           String   @default("US")
  contactEmail          String?
  senderId              String?
  billToAddressId       String?
  shipToAddressId       String?
  sandbox               Boolean  @default(true)
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  lastValidatedAt       DateTime?
  lastValidationStatus  String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Td_SynnexCredential {
  shopDomain            String   @id
  userName              String
  password              String
  customerNumber        String
  customerName          String?
  sandbox               Boolean  @default(true)
  lastValidatedAt       DateTime?
  lastValidationStatus  String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CarrierConfiguration {
  id           String   @id @default(cuid())
  shopDomain   String
  carrierCode  String   // e.g., "UG", "RG", "U3"
  carrierName  String   // e.g., "UPS GROUND", "FEDEX GROUND"
  carrierMode  String   // e.g., "SML", "AIR", "LTL"
  displayName  String?  // Custom name for checkout (optional)
  enabled      Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([shopDomain, carrierCode])
  @@index([shopDomain])
}

model RateRequestLog {
  id              String   @id @default(cuid())
  shopDomain      String
  correlationId   String   @unique
  requestType     String   // "carrier_service" or "cart_estimate"

  // Request info
  cartItemCount   Int
  cartSkus        String   // JSON array of SKUs
  ingramPartNums  String?  // JSON array of mapped part numbers
  shipToCity      String?
  shipToState     String?
  shipToZip       String?
  shipToCountry   String?

  // Response info
  status          String   // "success", "error", "no_rates", "no_mapping", "api_error"
  distributionCount Int?
  ratesReturned   Int?
  ratesData       String?  // JSON of rates returned (truncated)

  // Error info
  errorMessage    String?
  errorDetails    String?  // JSON of error details

  // Ingram API info
  ingramRawResponse String? // JSON of raw Ingram response (truncated for storage)

  // Timing
  durationMs      Int?
  createdAt       DateTime @default(now())

  @@index([shopDomain])
  @@index([createdAt])
  @@index([status])
}

model ProductMapping {
  id               String   @id @default(cuid())
  shopDomain       String
  sku              String
  ingramPartNumber String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([shopDomain, sku])
  @@index([shopDomain])
}

model ProductSyncJob {
  id         String   @id @default(cuid())
  shopDomain String
  status     String   // queued, running, success, failed
  processed  Int      @default(0)
  total      Int      @default(0)
  error      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  finishedAt DateTime?

  @@index([shopDomain])
  @@index([status])
  @@index([createdAt])
}

model FallbackRateSettings {
  shopDomain  String   @id
  enabled     Boolean  @default(true)
  price       Float    @default(999.00)  // Price in dollars
  title       String   @default("Shipping Unavailable")
  description String   @default("Please contact support before placing this order")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}